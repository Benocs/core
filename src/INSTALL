#!/bin/bash

set -e

BUILD_PARALLEL="-j2"
CORECFG="/etc/core"
PYTHON=python3

export PYTHON
su -c "apt-get update; apt-get purge quagga snmpd libsnmp-dev; \
    apt-get install bash bridge-utils ebtables iproute libev-dev python \
    tcl8.5 tk8.5 libtk-img gawk \
    autoconf automake gcc libev-dev make libreadline-dev pkg-config \
    imagemagick help2man unionfs-fuse libpcap-dev \
    python3 python3-dev bind9 lighttpd \
    tmux" root

daemons="bind9 lighttpd"
su -c "(for daemon in $daemons; do \
            update-rc.d -f \$daemon remove || echo \"error while deactivating \
            \$daemon\'s \ init script. check output.\"; done)" root

su -c "apt-get install dnsmasq" root

daemons="dnsmasq"
su -c "(for daemon in $daemons; do \
            update-rc.d -f \$daemon remove || echo \"error while deactivating \
            \$daemon\'s \ init script. check output.\"; done)" root

./bootstrap.sh
./configure --prefix=/usr

make $BUILD_PARALLEL
#TODO: chmod -R 775 "$CORECFG" && \
su -c "make install && \
    mkdir -p "$CORECFG" && \
    chmod -R 777 "$CORECFG" && \
    addgroup core || echo \"group \\\"core\\\" already exists. this can be ignored\" && \
    chgrp -R core \"$CORECFG\" && \
    cp -v files/brite.conf \"$CORECFG/\" && \
    cp -v files/ipaddrs.conf \"$CORECFG/\" && \
    cp -v files/nodes.conf \"$CORECFG/\" && \
    cp -v files/pvfs.conf \"$CORECFG/\" && \
    cp -v files/widgets.conf \"$CORECFG/\" && \
    ln -s \"$CORECFG\" /root/.core || echo \"link already exists. this can be ignored\" && \
    (for i in /home/*; do \
        echo \"creating link in \"\$i\"\"; ln -s \"$CORECFG\" \"\$i/.core\" || \
        echo \"link already exists. this can be ignored\"; done)" root

echo "building and installing quagga..."
su -c "( cd ../contrib/quagga && \
    tar -xzf quagga-0.99.22.4.tar.gz && \
    cd quagga-0.99.22.4 && \
    patch -p1 < ../000-vtysh.patch && \
    ./configure --prefix= \
        --enable-snmp \
        --enable-isisd \
        --enable-multipath=1 \
        --sysconfdir=/etc/quagga \
        --enable-vtysh \
        --localstatedir=/var/run/quagga && \
    make $BUILD_PARALLEL && \
    make install && \
    cd .. && \
    mkdir -p /etc/quagga && \
    cp -v ./debian.conf /etc/quagga/ && \
    cp -v ./quagga /etc/init.d/ && \
    update-rc.d -f quagga remove)" root

su -c "adduser --system --shell /bin/false --no-create-home --group --disabled-password --disabled-login quagga" root

echo "building and installing pmacct..."
(
cd ../contrib/pmacct
tar -xzf pmacct-1.5.0rc3.tar.gz
cd pmacct-1.5.0rc3
./configure --enable-l2 --enable-ipv6 --enable-plabel --enable-v4-mapped --enable-64bit --enable-threads --enable-ulog
make
su -c "make install" root
)

echo "building and installing softflowd"
(
cd ../contrib/
tar -xzf softflowd-80aac3b2fec3.tgz
cd softflowd
aclocal
autoheader
autoconf
./configure
make
su -c "make install" root
)

echo "building and installing BENOCS ifindex"
(
cd ../contrib/BENOCS/ifindex/src
g++ -o ifindex ifindex.cpp
su -c "mkdir -p /opt/BENOCS/bin && cp ifindex /opt/BENOCS/bin/ifindex" root
)

# TODO: softflowd
# TODO: /opt/BENOCS/bin/ifindex

echo "done. now for each user using core, create a symlink pointing from \"$HOME/.core\" -> \"$CORECFG\""

