#!/bin/bash

set -e

BUILD_PARALLEL="-j2"
CORECFG="/etc/core"
PYTHON=python3

export PYTHON
su -c "apt-get purge quagga; apt-get install bash bridge-utils ebtables iproute libev-dev python \
    tcl8.5 tk8.5 libtk-img gawk snmpd libsnmp-dev \
    autoconf automake gcc libev-dev make libreadline-dev pkg-config \
    imagemagick help2man unionfs-fuse \
    python3 python3-dev dnsmasq bind9 lighttpd \
    tmux" root

daemons="dnsmasq bind9 lighttpd"
su -c "(for daemon in $daemons; do \
            update-rc.d -f \$daemon remove || echo \"error while deactivating \
            \$daemon\'s \ init script. check output.\"; done)" root

./bootstrap.sh
./configure --prefix=/usr

make $BUILD_PARALLEL
#TODO: chmod -R 775 "$CORECFG" && \
su -c "make install && \
    mkdir -p "$CORECFG" && \
    chmod -R 777 "$CORECFG" && \
    addgroup core || echo \"group \\\"core\\\" already exists. this can be ignored\" && \
    chgrp -R core \"$CORECFG\" && \
    cp -v files/brite.conf \"$CORECFG/\" && \
    cp -v files/nodes.conf \"$CORECFG/\" && \
    cp -v files/ipaddrs.conf \"$CORECFG/\" && \
    cp -v files/widgets.conf \"$CORECFG/\" && \
    ln -s \"$CORECFG\" /root/.core || echo \"link already exists. this can be ignored\" && \
    (for i in /home/*; do \
        echo \"creating link in \"\$i\"\"; ln -s \"$CORECFG\" \"\$i/.core\" || \
        echo \"link already exists. this can be ignored\"; done)" root

echo "building and installing quagga..."
su -c "( cd ../contrib/quagga && \
    tar -xzf quagga-0.99.22.4.tar.gz && \
    cd quagga-0.99.22.4 && \
    patch -p1 < ../000-vtysh.patch && \
    ./configure --prefix= \
        --enable-snmp=agentx \
        --enable-isisd \
        --enable-multipath=1 \
        --sysconfdir=/etc/quagga \
        --enable-vtysh \
        --localstatedir=/var/run/quagga && \
    make $BUILD_PARALLEL && \
    make install && \
    cd .. && \
    mkdir -p /etc/quagga && \
    cp -v ./debian.conf /etc/quagga/ && \
    cp -v ./quagga /etc/init.d/ && \
    update-rc.d -f quagga remove || echo \"error while deactivating quagga\'s \
        init script. check output.\")" root

echo "building and installing pmacct..."
(
cd ../contrib/pmacct
tar -xzf pmacct-1.5.0rc3.tar.gz
cd pmacct-1.5.0rc3
./configure --enable-l2 --enable-ipv6 --enable-plabel --enable-v4-mapped --enable-64bit --enable-threads --enable-ulog
make
su -c "make install" root
)

echo "done. now for each user using core, create a symlink pointing from \"$HOME/.core\" -> \"$CORECFG\""

