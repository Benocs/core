#!/bin/bash

set -e

BUILD_PARALLEL="-j2"
CORECFG="/etc/core"
PYTHON=python3

export PYTHON
su -c "apt-get install bash bridge-utils ebtables iproute libev-dev python \
    tcl8.5 tk8.5 libtk-img \
    autoconf automake gcc libev-dev make libreadline-dev pkg-config \
    imagemagick help2man unionfs-fuse \
    python3 python3-dev quagga dnsmasq bind9 lighttpd \
    tmux" root

./bootstrap.sh
./configure --prefix=/usr

make $BUILD_PARALLEL
su -c "make install && \
    mkdir -p "$CORECFG" && \
    chmod -R 775 "$CORECFG" && \
    addgroup core || echo \"group \\\"core\\\" already exists. this can be ignored\" && \
    chgrp -R core \"$CORECFG\" && \
    cp -v files/brite.conf \"$CORECFG/\" && \
    cp -v files/nodes.conf \"$CORECFG/\" && \
    cp -v files/ipaddrs.conf \"$CORECFG/\" && \
    cp -v files/widgets.conf \"$CORECFG/\" && \
    ln -s \"$CORECFG\" /root/.core || echo \"link already exists. this can be ignored\"" root

echo "done. now for each user using core, create a symlink pointing from \"$HOME/.core\" -> \"$CORECFG\""

